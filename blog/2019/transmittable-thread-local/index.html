<!doctype html><html class=no-js lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>【review-项目】TransmittableThreadLocal 导致的线程数据逸出 - youzipi</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="解决因使用 TransmittableThreadLocal 导致的线程数据逸出。ThreadLocal，ITL，TTL 的原理解析。"><meta property="og:title" content="【review-项目】TransmittableThreadLocal 导致的线程数据逸出"><meta property="og:description" content="解决因使用 TransmittableThreadLocal 导致的线程数据逸出。ThreadLocal，ITL，TTL 的原理解析。"><meta property="og:type" content="article"><meta property="og:url" content="http://youzipi.org/blog/2019/transmittable-thread-local/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-02-18T18:40:13+00:00"><meta property="article:modified_time" content="2022-03-01T16:35:57+08:00"><meta itemprop=name content="【review-项目】TransmittableThreadLocal 导致的线程数据逸出"><meta itemprop=description content="解决因使用 TransmittableThreadLocal 导致的线程数据逸出。ThreadLocal，ITL，TTL 的原理解析。"><meta itemprop=datePublished content="2019-02-18T18:40:13+00:00"><meta itemprop=dateModified content="2022-03-01T16:35:57+08:00"><meta itemprop=wordCount content="4149"><meta itemprop=keywords content="ThreadLocal,InheritableThreadLocal,TransmittableThreadLocal,"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-32BLR3ZEP9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-32BLR3ZEP9",{anonymize_ip:!1})}</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?c643c263feccaa1f939a6bf06afddddd",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2186345094487950" crossorigin=anonymous></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title=youzipi rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/avatar.jpg></div><div class="logo__item logo__text"><div class=logo__title>youzipi</div><div class=logo__tagline>developer</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/blog/><span class=menu__text>blog</span></a></li><li class=menu__item><a class=menu__link href=/archives/><span class=menu__text>archives</span></a></li><li class=menu__item><a class=menu__link href=/categories/><span class=menu__text>categories</span></a></li><li class=menu__item><a class=menu__link href=/tags/><span class=menu__text>tags</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>about</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>【review-项目】TransmittableThreadLocal 导致的线程数据逸出</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>youzipi</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2019-02-18T18:40:13Z>February 18, 2019</time>
<time class=meta__text datetime=2022-03-01T16:35:57+08:00>(最后修改: March 01, 2022)</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/review/ rel=category>review</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>目录</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#背景>背景</a><ul><li><a href=#现象>现象</a></li><li><a href=#原因>原因</a></li><li><a href=#解决>解决</a></li></ul></li><li><a href=#transmittablethreadlocal>TransmittableThreadLocal</a><ul><li><a href=#为什么-ttl-不直接继承-threadlocal而继承-itl>为什么 TTL 不直接继承 ThreadLocal，而继承 ITL？</a></li><li><a href=#关于开源项目-功能实现修改-的讨论>关于开源项目 功能实现修改 的讨论</a></li><li><a href=#实现>实现</a></li></ul></li><li><a href=#inheritablethreadlocal>InheritableThreadLocal</a><ul><li><a href=#场景>场景</a><ul><li><a href=#itl-在-spring-requestcontextholder-中的使用>ITL 在 Spring RequestContextHolder 中的使用</a></li></ul></li><li><a href=#实现-1>实现</a><ul><li><a href=#数据传递过程>数据传递过程</a></li><li><a href=#为什么-childvalue-是-定义在-tl-中的而不是定义在-itl-中>为什么 childValue 是 定义在 TL 中的，而不是定义在 ITL 中？</a><ul><li><a href=#把-childvalue-定义在-itl-中要做的工作>把 childValue 定义在 ITL 中，要做的工作</a></li></ul></li></ul></li><li><a href=#itl-vs-threadlocal>ITL vs ThreadLocal</a></li></ul></li><li><a href=#threadlocal>ThreadLocal</a></li><li><a href=#总结>总结</a><ul><li><a href=#threadlocal-1>ThreadLocal</a></li><li><a href=#itl>ITL</a></li><li><a href=#ttl>TTL</a></li></ul></li><li><a href=#todo>todo</a></li></ul></nav></div></div><div class="content post__content clearfix"><blockquote><p>解决因使用 <code>TransmittableThreadLocal</code> 导致的线程数据逸出。ThreadLocal，ITL，TTL 的原理解析。</p></blockquote><p>alias：<br>TransmittableThreadLocal: TTL<br>InheritableThreadLocal: ITL</p><h1 id=背景>背景</h1><h2 id=现象>现象</h2><p>数据错乱：</p><ul><li>商务人员认领线索后，线索的持有人是其他商务人员。</li><li>一些记录的操作人与事实不符。</li></ul><h2 id=原因>原因</h2><p>项目引入 TTL：<br>批量审批的操作很慢，于是改用了线程池去处理。<br>最后更新审批状态的 DB 的时候，需要填充操作人信息，这些信息是保存在 ThreadLocal 中的。<br>但是没法传递 threadLocal，使用 ITL 也不行。<br>于是，引入了TTL 用以解决：向<code>线程池中的线程</code>传递 当前请求的 threadLocal。</p><p>项目定义了一个 contextHandler 用于保存 当前登录用户的一些信息，token, currrentUserId 之类。<br>contextHandler 使用 <code>TransmittableThreadLocal</code> 保存内容。</p><p>项目启动后，有一些初始化的操作，其中需要通过 feign 去调用其他的服务。<br>而 feign 配置的拦截器中，有从 contextHandler 中获取 token 的操作。即调用了 <code>threadLocal.get()</code> 方法，导致主线程 threadLocal 的数据初始化了，并保存到了 thread 中。<br>以上都是发生在 <code>main 线程</code>中的。</p><p>之后，新的 http 请求进入，从主线程创建新的线程去处理。<br>因为 TTL 继承自 ITL，所以，创建线程的过程中，主线程的 threadLocal 中的数据被复制到了 处理 http 请求的子线程中。<br>因为 threadLocal 保存的是一个 map 对象。所以，事实上，所有的 处理 http 请求的线程 <code>读取</code>、<code>写入</code>、<code>清空</code> 操作的都是同一个 map。即：<code>数据从 主线程 逸出到了整个应用中</code>。<br>准确的说，所有同时处理 http 请求的线程共享同一个 map。<br>因为 在 拦截器的 <code>afterCompletion</code>是配置了清空 threadLocal 数据的。<br>所以，实际上是：</p><ul><li>应用启动后，threadLocal.get() 触发了 map 初始化。</li><li>新进来 http 请求，需要创建新的线程，此时 main 线程的 threadLocal.map 复制给了 servlet 线程。（传递引用）</li><li>servlet 线程 处理请求，结束后，执行 <code>afterCompletion</code>，清空 threadLocal，同时也断开了 和 main 线程中 threadLocal 的关系。但是此时，其他未结束的 servlet 线程中的 threadLocal 也被清空了。</li><li>长时间运行后，servlet 所在线程池中的所有线程都被清空了一次。都是独立的了，再之后的数据就不会有问题了。</li></ul><blockquote><p>ThreadLocal 是在第一次调用 get() 方法时 “初始化”的：注册到 thread 中。</p></blockquote><h2 id=解决>解决</h2><p>重新翻阅了 TTL 的 README，issue，源码。<br>最后在源代码里，看到了官方提供了关于这个问题的解决：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#f92672>*</span> You can turn on <span style=color:#e6db74>&#34;disable inheritable for thread pool&#34;</span> by <span style=color:#f92672>{</span><span style=color:#a6e22e>@link</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>alibaba</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ttl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadpool</span><span style=color:#f92672>.</span><span style=color:#a6e22e>agent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>TtlAgent</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> so as to wrap thread factory <span style=color:#66d9ef>for</span> thread pooling components
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> <span style=color:#f92672>({</span><span style=color:#a6e22e>@link</span> java<span style=color:#f92672>.</span><span style=color:#a6e22e>util</span><span style=color:#f92672>.</span><span style=color:#a6e22e>concurrent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ThreadPoolExecutor</span><span style=color:#f92672>},</span> <span style=color:#f92672>{</span><span style=color:#a6e22e>@link</span> java<span style=color:#f92672>.</span><span style=color:#a6e22e>util</span><span style=color:#f92672>.</span><span style=color:#a6e22e>concurrent</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ForkJoinPool</span><span style=color:#f92672>})</span> automatically and transparently<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> <span style=color:#f92672>&lt;</span>p<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>❷</span> or by overriding method <span style=color:#f92672>{</span><span style=color:#a6e22e>@link</span> <span style=color:#960050;background-color:#1e0010>#</span>childValue<span style=color:#f92672>(</span>Object<span style=color:#f92672>)}.</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> Whether the value should be inheritable or not can be controlled by the data owner<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> disable it <span style=color:#f92672>&lt;</span>b<span style=color:#f92672>&gt;</span>carefully<span style=color:#f92672>&lt;/</span>b<span style=color:#f92672>&gt;</span> when data owner have a clear idea<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>TransmittableThreadLocal<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> transmittableThreadLocal <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>new</span> TransmittableThreadLocal<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> String <span style=color:#a6e22e>childValue</span><span style=color:#f92672>(</span>String parentValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> initialValue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>TTL 继承自 ITL，<br>ITL 的 childValue 方法是 <code>return parentValue;</code>。<br>这里，我们 override <code>childValue</code> 方法，<br>改为调用 <code>TTL.initialValue()</code> 也就是 <code>ThreadLocal.initialValue</code>，内容是 <code>return null;</code></p><h1 id=transmittablethreadlocal>TransmittableThreadLocal</h1><h2 id=为什么-ttl-不直接继承-threadlocal而继承-itl>为什么 TTL 不直接继承 ThreadLocal，而继承 ITL？</h2><p>解决了这个问题后，又有了新的疑问：库的名字叫做 Transmittable ，那是不是 不应该提供 inheritable 的功能？<br>出现这个问题的原因是，我看到这个名字，下意识地把它当成了 传递的，忘记了它同时也是 继承的。<br>issue 里面也有相似的讨论：<br><a href=https://github.com/alibaba/transmittable-thread-local/issues/100>disable Inheritable when it&rsquo;s not necessary and buggy(eg. has potential memory leaking problem)</a><br>我在这个 issue 下面进行了提问：</p><blockquote><p>为什么 TTL 不直接继承 ThreadLocal，而继承 ITL？<br>建议 把 inheritable 改为可选参数。<br>作者回复：</p></blockquote><ol><li>向下兼容</li><li>需要提供在 <code>new Thread</code>的情况下，也能进行传递。</li><li><code>inheritable</code> 在业务上 有潜在的（<strong><em>potential</em></strong>）的 泄漏或污染。</li></ol><h2 id=关于开源项目-功能实现修改-的讨论>关于开源项目 功能实现修改 的讨论</h2><p>这里还有另个一个事例：<br><a href=https://github.com/alibaba/transmittable-thread-local/pull/95>[代码优化] 把 TTL 中的 holder 封装为 Set，便于阅读</a><br>TTL 中用来实际存储的 holder 是 一个 Map 类型，但是是当做 Set 来使用的。<br>看源代码的时候，这里也是被困扰了：这个 map 的所有 put 方法传入的 value 都是 null。<br>实现 与 语义不一致。<br>作者坚持没有合入这个 feature。<br>理由：</p><ul><li><code>TTL</code>是非常下层的库，期望极致减少可能的Overhead。</li><li>因为库内部实现 且 实现逻辑的代码非常少 => 通用设计的封装性 有些 反模式 是在代码维护性上还是可以接受。</li><li>如果我合进来了，因为对一个下层库可能有的性能影响，肯定会有不同的同学来反复问我这个问题，而我需要反复给予解释（维护者的痛苦深渊）。</li></ul><p>总结一下：</p><ul><li>性能问题。越是底层的库，调用次数越是频繁，任何一点性能差别都会被放到很大。</li><li>功能的实现是 <code>内部的</code>，而且是 <code>简单的</code>，可以牺牲可读性。比如 JDK 源码中有很多的位运算，其实是可读性很差的。（但是，这个项目中，这点理由其实不成立。）</li><li>作为一个开源项目，要考虑向前兼容，使用者可能会以你意想不到的方式使用这个库，所以要尽可能地<code>遵从历史</code>。<ul><li>对于新的实现，用户出现问题，可能会导致巨大的沟通成本。（但我觉得，这是因为工具的局限性，没有一个特别好的 代码变更的讨论，（投票）工具。）</li><li>对于开源项目，一定要尽可能地少暴露接口。如无必要，不要暴露实现。只给用户提供必要的接口。</li></ul></li><li>从 issue 提出方，当更换了底层的实现（比如：数据结构）时，考虑提供 beanchmark 报告。</li></ul><h2 id=实现>实现</h2><p>包装 Runnable<br>把 threadLocal 保存到 <code>private final AtomicReference&lt;Object> capturedRef;</code> 中。<br>在 线程执行 之前，把数据填充回 threadLocal 中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>TtlRunnable</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nonnull</span> Runnable runnable<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> releaseTtlValueReferenceAfterRun<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>capturedRef</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;(</span>capture<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>runnable</span> <span style=color:#f92672>=</span> runnable<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>releaseTtlValueReferenceAfterRun</span> <span style=color:#f92672>=</span> releaseTtlValueReferenceAfterRun<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * wrap method {@link Runnable#run()}.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Object captured <span style=color:#f92672>=</span> capturedRef<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>captured <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> releaseTtlValueReferenceAfterRun <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>capturedRef<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSet</span><span style=color:#f92672>(</span>captured<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TTL value reference is released after run!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Object backup <span style=color:#f92672>=</span> replay<span style=color:#f92672>(</span>captured<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            runnable<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            restore<span style=color:#f92672>(</span>backup<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// com.alibaba.ttl.TransmittableThreadLocal.Transmitter#capture
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Object <span style=color:#a6e22e>capture</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Map<span style=color:#f92672>&lt;</span>TransmittableThreadLocal<span style=color:#f92672>&lt;?&gt;,</span> Object<span style=color:#f92672>&gt;</span> captured <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>TransmittableThreadLocal<span style=color:#f92672>&lt;?&gt;,</span> Object<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>TransmittableThreadLocal<span style=color:#f92672>&lt;?&gt;</span> threadLocal <span style=color:#f92672>:</span> holder<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>().</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                captured<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>threadLocal<span style=color:#f92672>,</span> threadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>copyValue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> captured<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><p><img src=https://github.com/alibaba/transmittable-thread-local/raw/master/docs/TransmittableThreadLocal-sequence-diagram.png alt></p><h1 id=inheritablethreadlocal>InheritableThreadLocal</h1><p><code>@since 1.2</code><br>类注释：</p><blockquote><p>This class extends ThreadLocal to provide inheritance of values from parent thread to child thread: when a child thread is created, the child receives initial values for all inheritable thread-local variables for which the parent has values. Normally the child&rsquo;s values will be identical to the parent&rsquo;s; however, the child&rsquo;s value can be made an arbitrary function of the parent&rsquo;s by overriding the childValue method in this class.</p></blockquote><h2 id=场景>场景</h2><ul><li>线程中的变量 需要在 创建子线程的时候，自动传递给子线程。<br>ex: user-id, transaction-id</li></ul><h3 id=itl-在-spring-requestcontextholder-中的使用>ITL 在 Spring RequestContextHolder 中的使用</h3><p>NamedInheritableThreadLocal 是 ITL 的子类<br>NamedThreadLocal 是 ThreadLocal 的子类<br>两个子类都是只增加了一个 name 属性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// org.springframework.web.context.request.RequestContextHolder#inheritableRequestAttributesHolder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestContextHolder</span>  <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不继承的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>RequestAttributes<span style=color:#f92672>&gt;</span> requestAttributesHolder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NamedThreadLocal<span style=color:#f92672>&lt;&gt;(</span><span style=color:#e6db74>&#34;Request attributes&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 可继承的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ThreadLocal<span style=color:#f92672>&lt;</span>RequestAttributes<span style=color:#f92672>&gt;</span> inheritableRequestAttributesHolder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NamedInheritableThreadLocal<span style=color:#f92672>&lt;&gt;(</span><span style=color:#e6db74>&#34;Request context&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RequestAttributes <span style=color:#a6e22e>getRequestAttributes</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		RequestAttributes attributes <span style=color:#f92672>=</span> requestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>attributes <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			attributes <span style=color:#f92672>=</span> inheritableRequestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> attributes<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setRequestAttributes</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> RequestAttributes attributes<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> inheritable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>attributes <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			resetRequestAttributes<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>inheritable<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 如果是 继承的话？
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				inheritableRequestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>attributes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				requestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				requestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>attributes<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				inheritableRequestAttributesHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// org.springframework.web.filter.RequestContextFilter
</span></span></span><span style=display:flex><span><span style=color:#75715e>// org.springframework.web.servlet.FrameworkServlet
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 这两个类 使用了 threadContextInheritable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>RequestContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequestAttributes</span><span style=color:#f92672>(</span>requestAttributes<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadContextInheritable</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p><code>setThreadContextInheritable</code> 的注释：</p><blockquote><p>Set whether to expose the LocaleContext and RequestAttributes as inheritable for child threads (using an {@link java.lang.InheritableThreadLocal}).<br>Default is &ldquo;false&rdquo;, to avoid side effects on spawned background threads.<br>Switch this to &ldquo;true&rdquo; to enable inheritance for custom child threads which are spawned during request processing and only used for this request (that is, ending after their initial task, without reuse of the thread).<br>WARNING: Do not use inheritance for child threads if you are accessing a thread pool which is configured to potentially add new threads on demand (e.g. a JDK {@link java.util.concurrent.ThreadPoolExecutor}), since this will expose the inherited context to such a pooled thread</p></blockquote><p>如果使用线程池的话，不要 在子线程上使用继承，因为 继承的 context 会被暴露给 池子里的 线程（这个线程后面会被其他的“父线程”使用）</p><p>实际使用时，如果 数据 保存在 ITL 中，则 创建 子线程的时候，会被传递给 子线程的 ITL。<br>如果 数据 保存在 <code>ThreadLocal</code> 中的话，就不处理。<br>即 如果数据要 继承的话，需要 指明保存到 <code>InheritableThreadLocal</code> 中。</p><p>使用线程池的情况下，新的线程不是由父线程创建的，而是由线程池创建的。<br>父线程做的事情是把 任务 提交给线程池。</p><p>如何 在使用线程池的情况下，提供 ThreadLocal 值 的传递，解决异步执行任务时， context 传递 的问题？<br>应用需要的实际上是把 <code>任务提交给线程池时</code>的ThreadLocal值传递到 <code>任务执行时</code>。</p><p><a href=https://blog.csdn.net/v123411739/article/details/79117430>https://blog.csdn.net/v123411739/article/details/79117430</a></p><p><a href=http://xiangshouxiyang.iteye.com/blog/2391477>配合线程池定义可继承的线程变量InheritableThreadLocal_csdn</a></p><h2 id=实现-1>实现</h2><p>在创建子线程的时候，把 父线程中的 ITL中的 map 复制给 子线程</p><ul><li>childValue</li></ul><p>需要被重写。<br>因为 ThreadLocal 里面如果存放的是 对象的话，那么根据代码，传递的就是引用，也就是，任何子线程的修改都会影响到 所有的父线程 以及 父线程所有的子线程。<code>变量 实际上逸出到了整个线程树。</code>，这常常不是我们想要的。</p><p><strong>This method is called from within the parent thread before the child is started.</strong></p><h3 id=数据传递过程>数据传递过程</h3><p>创建子线程的 调用链：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>|-</span>Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>init</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>--</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span> <span style=color:#f92672>=</span> ThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>createInheritedMap</span><span style=color:#f92672>(</span>parent<span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|-</span><span style=color:#66d9ef>new</span> ThreadLocalMap<span style=color:#f92672>(</span>parentMap<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>--</span>key<span style=color:#f92672>.</span><span style=color:#a6e22e>childValue</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>);</span> <span style=color:#75715e>// key: ThreadLocal, e: ThreadLocal.ThreadLocalMap.Entry
</span></span></span></code></pre></div><p>相关实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// java.lang.Thread#init
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span><span style=color:#f92672>(</span>ThreadGroup g<span style=color:#f92672>,</span> Runnable target<span style=color:#f92672>,</span> String name<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>long</span> stackSize<span style=color:#f92672>,</span> AccessControlContext acc<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Thread parent <span style=color:#f92672>=</span> currentThread<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// some code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>parent<span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 复制 父线程（当前线程）的 inheritableThreadLocals 到子线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span> <span style=color:#f92672>=</span> ThreadLocal<span style=color:#f92672>.</span><span style=color:#a6e22e>createInheritedMap</span><span style=color:#f92672>(</span>parent<span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// some code
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// java.lang.ThreadLocal#createInheritedMap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> ThreadLocalMap <span style=color:#a6e22e>createInheritedMap</span><span style=color:#f92672>(</span>ThreadLocalMap parentMap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ThreadLocalMap<span style=color:#f92672>(</span>parentMap<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// java.lang.ThreadLocal.ThreadLocalMap#ThreadLocalMap(java.lang.ThreadLocal.ThreadLocalMap)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ThreadLocalMap</span><span style=color:#f92672>(</span>ThreadLocalMap parentMap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Entry<span style=color:#f92672>[]</span> parentTable <span style=color:#f92672>=</span> parentMap<span style=color:#f92672>.</span><span style=color:#a6e22e>table</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> len <span style=color:#f92672>=</span> parentTable<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    setThreshold<span style=color:#f92672>(</span>len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    table <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>[</span>len<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span> j <span style=color:#f92672>&lt;</span> len<span style=color:#f92672>;</span> j<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Entry e <span style=color:#f92672>=</span> parentTable<span style=color:#f92672>[</span>j<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>e <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@SuppressWarnings</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unchecked&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            ThreadLocal<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> key <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ThreadLocal<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;)</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>key <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 * 这里调用 ITL 的 `childValue(parentValue)`，进行 值复制，
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 * 在 childValue 里面决定复制方案：直接传递（引用|值），浅复制，深复制
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 */</span> 
</span></span><span style=display:flex><span>                Object value <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>childValue</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                Entry c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Entry<span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> h <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocalHashCode</span> <span style=color:#f92672>&amp;</span> <span style=color:#f92672>(</span>len <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>table<span style=color:#f92672>[</span>h<span style=color:#f92672>]</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    h <span style=color:#f92672>=</span> nextIndex<span style=color:#f92672>(</span>h<span style=color:#f92672>,</span> len<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                table<span style=color:#f92672>[</span>h<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> c<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                size<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>ThreadLocalMap 是 ThreadLocal 的 static 内部类。<br>createInheritedMap 是 ThreadLocal 的一个 static 方法。<br><code>private ThreadLocalMap(ThreadLocalMap parentMap)</code> 只在 <code>ThreadLocal.createInheritedMap()</code> 中被调用，通过 其中的 childValue 进行父子线程的数据传递。<br>ThreadLocal 的childValue 方法是：<code>throw new UnsupportedOperationException();</code><br>那么，</p><h3 id=为什么-childvalue-是-定义在-tl-中的而不是定义在-itl-中>为什么 childValue 是 定义在 TL 中的，而不是定义在 ITL 中？</h3><p><a href=https://stackoverflow.com/questions/54104706/why-childvalue-is-defined-in-threadlocal-instead-of-in-inheritablethreadlocal>why childValue() is defined in ThreadLocal instead of in InheritableThreadLocal？</a><br>在 sof 上提了问，没人回答。。。</p><p>jdk 文档的解释：</p><blockquote><p>Method childValue is visibly defined in subclass InheritableThreadLocal,<br>but is internally defined here <code>for the sake of providing createInheritedMap factory method without needing to subclass the map class in InheritableThreadLocal</code>.<br>This technique is preferable to the alternative of embedding instanceof tests in methods.</p></blockquote><p>是为了方便提供 createInheritedMap 这个工厂方法。<br>在这里实现，比最后需要通过 <code>instanceof</code> 去区分要好。<br>但是，IMO，ThreadLocal 根本没有 继承相关的语义啊，为什么不把所有相关的都定义在 ITL 中？<br><strong>todo</strong><br>因为 createInheritedMap 被提升到了 TL 中，<br>ITL 对于 TL 是不可知的。</p><h4 id=把-childvalue-定义在-itl-中要做的工作>把 childValue 定义在 ITL 中，要做的工作</h4><p>如果要把 childValue 定义在 ITL 中，<br>那么需要</p><ul><li>把 <code>createInheritedMap</code> 定义在 ITL 中</li><li>把 <code>private ThreadLocalMap(ThreadLocalMap parentMap)</code> 定义在 ITL 中<ul><li>在 ITL 中提供 <code>ThreadLocal.ThreadLocalMap</code>的子类，实现 <code>private ThreadLocalMap(ThreadLocalMap parentMap)</code> 方法。</li></ul></li></ul><h2 id=itl-vs-threadlocal>ITL vs ThreadLocal</h2><p>区别很明显，很好理解。</p><ul><li><p>getMap<br>很简单，就是 override 了 ThreadLocal 的 getMap 方法。<br>TL 从 thread.threadLocals 中 取 map<br>ITL 从 thread.inheritableThreadLocals 取 map<br>也就是 一个线程是同时存在 TL 和 ITL 的，把 需要发布的 放到 <code>inheritableThreadLocals</code> 里，需要封闭的 放到 <code>threadLocals</code> 里面。</p></li><li><p>createMap<br>TL.createMap: 创建 Thread 的 threadLocals，把 ThrealLocal:value 存到 Thread 的 threadLocals 里面<br>ITL.createMap: 创建 Thread 的 inheritableThreadLocals ThrealLocal:value 存到 Thread 的 inheritableThreadLocals 里面</p></li></ul><p>ITL 相关实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Computes the child&#39;s initial value for this inheritable thread-local
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * variable as a function of the parent&#39;s value at the time the child
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * thread is created.  This method is called from within the parent
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * thread before the child is started.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * &lt;p&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * This method merely returns its input argument, and should be overridden
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * if a different behavior is desired.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param parentValue the parent thread&#39;s value
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return the child thread&#39;s initial value
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> T <span style=color:#a6e22e>childValue</span><span style=color:#f92672>(</span>T parentValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> parentValue<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    ThreadLocalMap <span style=color:#a6e22e>getMap</span><span style=color:#f92672>(</span>Thread t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> t<span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createMap</span><span style=color:#f92672>(</span>Thread t<span style=color:#f92672>,</span> T firstValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        t<span style=color:#f92672>.</span><span style=color:#a6e22e>inheritableThreadLocals</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocalMap<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> firstValue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=threadlocal>ThreadLocal</h1><p><img src=https://user-images.githubusercontent.com/5629307/53001523-ca301200-3465-11e9-9215-226534cb2620.png alt><br><strong>todo</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>tl <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ThreadLocal<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>tl<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>():</span>
</span></span><span style=display:flex><span>    ThreadLocalMap map <span style=color:#f92672>=</span> t<span style=color:#f92672>.</span><span style=color:#a6e22e>threadLocals</span>
</span></span><span style=display:flex><span>    Entry e <span style=color:#f92672>=</span> map<span style=color:#f92672>.</span><span style=color:#a6e22e>getEntry</span><span style=color:#f92672>(</span>t1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// java.lang.ThreadLocal.ThreadLocalMap.Entry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Entry</span> <span style=color:#66d9ef>extends</span> WeakReference<span style=color:#f92672>&lt;</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>/** The value associated with this ThreadLocal. */</span>
</span></span><span style=display:flex><span>            Object value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            Entry<span style=color:#f92672>(</span>ThreadLocal<span style=color:#f92672>&lt;?&gt;</span> k<span style=color:#f92672>,</span> Object v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>k<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                value <span style=color:#f92672>=</span> v<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=总结>总结</h1><h2 id=threadlocal-1>ThreadLocal</h2><p>ThreadLocal 线程封闭的一种方案。<br>线程封闭 是用来避免 线程安全问题的。</p><h2 id=itl>ITL</h2><p>之后，为了方便在父子线程间方便的传递数据，引入了 ITL。<br>但是，ITL 有两个问题：</p><ol><li>ITL.childValue 方法，是直接返回 <code>parentValue</code>，没有进行深复制，如果存储的不是基本类型数据的话，相当于父线程及其所有子线程共享相同的引用，对其中数据的修改会影响到整个线程数。<br>所以，实际使用中，需要根据实际情况，override <code>ITL.childValue</code>。</li><li>ITL 的数据复制时机是：<code>线程创建时</code>，在线程池场景下，达不到想要的结果。</li></ol><h2 id=ttl>TTL</h2><p>针对 ITL 在线程池之类情况下的缺陷 ，出现了 TTL。<br>通过包装线程的方式，把复制时机 移到了 <code>线程启动时</code>，<br>TTL 的问题：<br>TTL 同时具有 ITL 的功能，如果不想要 继承 功能的话，需要注意手动地修改 childValue 方法。<br>正常使用 TTL 的方式，（在不适用 proxy 的情况下）是需要对线程或者线程池进行手动的封装的。不用担心这个问题。<br>但是，当 TTL 被当做普通 ThreadLocal 使用时，TTL 实际是等价于 ITL 的。</p><h1 id=todo>todo</h1><p>@Scheduled 定时任务 执行所在的线程？</p><p>CommandLineRunner 里面的 run 方法 和 定时任务和 @Configuration 中的 定时任务。</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/threadlocal/ rel=tag>ThreadLocal</a></li><li class=tags__item><a class="tags__link btn" href=/tags/inheritablethreadlocal/ rel=tag>InheritableThreadLocal</a></li><li class=tags__item><a class="tags__link btn" href=/tags/transmittablethreadlocal/ rel=tag>TransmittableThreadLocal</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/blog/2019/state-machine/ rel=prev><span class=pager__subtitle>«&#8201;上一篇</span><p class=pager__title>【review-项目】售前 CRM 项目中 有限状态机的使用，及操作日志的实现</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/blog/2019/template-pattern/ rel=next><span class=pager__subtitle>下一篇&#8201;»</span><p class=pager__title>【设计模式-实践】使用 模板模式 实现 微信微信模板消息推送</p></a></div></nav><section class=comments><div class="post bg-white"><script src=https://utteranc.es/client.js repo=youzipi/youzipi.github.io issue-term=title theme=github-light crossorigin=anonymous async></script></div></section></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=搜索… name=q aria-label=搜索…></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=http://youzipi.org/></form></div><div class="widget-recent widget"><h4 class=widget__title>近期文章</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/blog/2023/202303_mybatis_cache/>mybatis cache 导致 密码重复解密，报错</a></li><li class=widget__item><a class=widget__link href=/blog/2022/broker-load-balance/>pulsar broker load balance</a></li><li class=widget__item><a class=widget__link href=/blog/2021/aries-1/>ARIES(1/n) - 使用 WAL 实现 原子性和一致性</a></li><li class=widget__item><a class=widget__link href=/blog/2019/ddd-in-salary-calculation/>【DDD-实践】社保公积金，工资计算功能的实现</a></li><li class=widget__item><a class=widget__link href=/blog/2019/spring-boot-actuator-oom/>【review-项目】spring-cloud-gateway，spring-boot-actuator 导致 OOM</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>分类</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/blog/>blog</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/flask/>flask</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/java/>java</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/mq/>MQ</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/paper-reading/>paper-reading</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/practice/>practice</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/review/>review</a>&nbsp;
<span class="widget__counter widget__counter--bubble">5</span></li><li class=widget__item><a class=widget__link href=/categories/uncategorized/>uncategorized</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/%E4%BB%96%E5%B1%B1%E4%B9%8B%E7%8E%89/>他山之玉</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/%E6%80%BB%E7%BB%93/>总结</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/%E7%94%B5%E5%BD%B1/>电影</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>标签</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/aries/ title=ARIES>ARIES (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/blog/ title=blog>blog (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/broker/ title=broker>broker (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cache/ title=cache>cache (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/crm/ title=CRM>CRM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/db/ title=db>db (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/ddd/ title=DDD>DDD (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/flask/ title=flask>flask (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/fsm/ title=FSM>FSM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/hexo/ title=hexo>hexo (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/inheritablethreadlocal/ title=InheritableThreadLocal>InheritableThreadLocal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/java/ title=java>java (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/jvm/ title=JVM>JVM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/load-balance/ title=load-balance>load-balance (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/mybatis/ title=mybatis>mybatis (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/oom/ title=OOM>OOM (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/paper/ title=paper>paper (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/parser/ title=parser>parser (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/pulsar/ title=pulsar>pulsar (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/restful/ title=restful>restful (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/review/ title=review>review (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/spring-boot-actuator/ title=spring-boot-actuator>spring-boot-actuator (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/threadlocal/ title=ThreadLocal>ThreadLocal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/transmittablethreadlocal/ title=TransmittableThreadLocal>TransmittableThreadLocal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%88%87%E9%9D%A2/ title=切面>切面 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E5%BE%AE%E4%BF%A1%E6%A8%A1%E6%9D%BF%E6%B6%88%E6%81%AF/ title=微信模板消息>微信模板消息 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E7%94%B5%E5%BD%B1/ title=电影>电影 (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ title=设计模式>设计模式 (1)</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">社交</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Twitter rel="noopener noreferrer" href=https://twitter.com/youzipi870 target=_blank><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><span>Twitter</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Instagram rel="noopener noreferrer" href=https://www.instagram.com/wuyouzipi target=_blank><svg class="widget-social__link-icon icon icon-instagram" width="24" height="24" viewBox="0 0 256 256"><circle cx="193" cy="59" r="15"/><path fill-rule="evenodd" d="M101 0h54c41 0 58.4 3.9 74.5 17C256.2 37.5 256 74.8 256 97.7v60c0 26.7.0 60.4-26.5 81.4-16 13.4-33.5 16.9-74.5 16.9h-54c-41 0-57.5-3.5-74.5-16.9C1 218.9.5 186.3.1 160.5L0 155V97.7c0-23-.2-60.2 26.5-80.7C45 2 60 0 101 0zm4.9 23h44.3c45.8.0 58.3 3.5 70.3 17.5 11.8 13.2 12 30.1 12.5 62.9V156c.2 20.8.3 45.8-12.5 59.5-12 14-24.5 17.5-70.3 17.5h-44.3c-45.9.0-57.3-3.5-70.4-17.5-12.2-13-12.3-36.5-12.4-56.7v-55.6c.4-32.6.7-49.6 12.4-62.7C48 26.5 60 23 105.9 23zm19.6 144.5a42 42 0 100-84 42 42 0 000 84zm0 22.5a64.5 64.5.0 100-129 64.5 64.5.0 000 129z"/></svg><span>Instagram</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Telegram rel="noopener noreferrer" href=https://t.me/youzipi target=_blank><svg class="widget-social__link-icon icon icon-telegram" width="24" height="24" viewBox="0 0 132 110"><path fill="#ddd" d="M50 103c-4 0-3-1-5-5L34 60l88-52"/><path fill="#aaa" d="M50 103c3 0 4-1 6-3l16-16-20-12"/><path fill="#fff" d="M52 72l48 36c6 3 10 2 11-5l20-93c2-8-3-11-8-9L7 45c-8 4-8 8-1 10l29 9 69-43c3-2 6-1 4 1"/></svg><span>Telegram</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/youzipi target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2C329 348.2 384 276.4 384 191.7 384 85.8 298 0 192 0z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:blake_12@qq.com><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>blake_12@qq.com</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=douban rel="noopener noreferrer" href=https://www.douban.com/people/youzipi870/ target=_blank><span>douban</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/note/>note</a></div><div class=footer__copyright>&copy; 2023 youzipi.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> 主题</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>